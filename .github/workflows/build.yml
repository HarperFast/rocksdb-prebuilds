name: Automated RocksDB Builds

on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:

jobs:
  check:
    name: Check for new release
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check-build.outputs.should_build }}
      version: ${{ steps.latest-rocksdb.outputs.version }}
    steps:
      - name: Get latest RocksDB release
        id: latest-rocksdb
        shell: bash
        run: |
          URL="https://api.github.com/repos/facebook/rocksdb/releases/latest"
          LATEST=$(curl -s -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -X GET "$URL" | jq -r '.tag_name' | tr -d 'v')
          echo "Latest RocksDB release: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Get latest prebuild
        id: latest-prebuild
        shell: bash
        run: |
          URL="https://api.github.com/repos/harperdb/rocksdb-prebuilds/releases/latest"
          LATEST=$(curl -s -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -X GET "$URL" | jq -r '.tag_name' | tr -d 'v')
          echo "Latest RocksDB prebuild: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Check if we should build
        id: check-build
        shell: bash
        run: |
          if [[ "${{ steps.latest-rocksdb.outputs.version }}" != "${{ steps.latest-prebuild.outputs.version }}" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "New RocksDB release!"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No new RocksDB release"
          fi

  build:
    name: Build
    needs: [check]
    if: ${{ needs.check.outputs.should_build == 'true' }}
    strategy:
      fail-fast: true
      matrix:
        platform:
          - runner: macos-latest
            target: arm64-osx
          - runner: macos-latest
            target: x64-osx
          - runner: ubuntu-22.04
            target: x64-linux
          - runner: ubuntu-24.04-arm
            target: arm64-linux
          - runner: windows-latest
            target: x64-windows
          - runner: windows-latest
            target: arm64-windows
    runs-on: ${{ matrix.platform.runner }}
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    steps:
      - name: Install vcpkg
        shell: bash
        run: |
          git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          if [[ "${{ matrix.platform.runner }}" == *"windows"* ]]; then
            $VCPKG_ROOT/bootstrap-vcpkg.bat
            VCPKG_CMD="$VCPKG_ROOT/vcpkg.exe"
          else
            $VCPKG_ROOT/bootstrap-vcpkg.sh
            VCPKG_CMD="$VCPKG_ROOT/vcpkg"
          fi
          $VCPKG_CMD integrate install
          echo "VCPKG_CMD=$VCPKG_CMD" >> $GITHUB_ENV

      - name: Install compression libraries
        shell: bash
        run: |
          # install snappy, lz4, zlib, zstd with the correct triplet
          if [[ "${{ matrix.platform.runner }}" == *"windows"* ]]; then
            VCPKG_CMD="$VCPKG_ROOT/vcpkg.exe"
            $VCPKG_CMD install snappy lz4 zlib zstd --triplet ${{ matrix.platform.target }}
            echo "Verifying Snappy installation..."
            INSTALLED_INCLUDE="$VCPKG_ROOT/installed/${{ matrix.platform.target }}/include"
            if [[ -f "$INSTALLED_INCLUDE/snappy-sinksource.h" ]]; then
              echo "✓ snappy-sinksource.h found at root"
            elif [[ -f "$INSTALLED_INCLUDE/snappy/snappy-sinksource.h" ]]; then
              echo "✓ snappy-sinksource.h found in snappy/ subdirectory"
            else
              echo "✗ snappy-sinksource.h NOT found"
              echo "Checking installed directory structure:"
              find "$INSTALLED_INCLUDE" -name "*snappy*" -type f | head -20 || true
              echo "All files in include directory:"
              ls -la "$INSTALLED_INCLUDE/" || true
            fi
          else
            VCPKG_CMD="$VCPKG_ROOT/vcpkg"
            $VCPKG_CMD install snappy lz4 zlib zstd
          fi

      - name: Download and build RocksDB
        id: build
        shell: bash
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_TARGET_TRIPLET: ${{ matrix.platform.target }}
        run: |
          URL="https://github.com/facebook/rocksdb/archive/refs/tags/v${{ needs.check.outputs.version }}.tar.gz"
          echo "Downloading: $URL"
          curl -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -o rocksdb.tar.gz "$URL"
          tar -xzf rocksdb.tar.gz

          cd rocksdb-${{ needs.check.outputs.version }}
          mkdir build
          cd build
          echo "Building RocksDB..."
          echo "VCPKG_ROOT: $VCPKG_ROOT"
          echo "VCPKG_TARGET_TRIPLET: $VCPKG_TARGET_TRIPLET"
          if [[ "${{ matrix.platform.runner }}" == *"windows"* ]]; then
            # Convert Windows path to forward slashes for CMake
            TOOLCHAIN_FILE=$(echo "$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" | sed 's|\\|/|g')
            INSTALLED_DIR=$(echo "$VCPKG_ROOT/installed/${{ matrix.platform.target }}" | sed 's|\\|/|g')
            echo "Installed directory: $INSTALLED_DIR"
            echo "Checking Snappy headers:"
            ls -la "$INSTALLED_DIR/include/" | grep snappy || true
          else
            TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          fi
          echo "Toolchain file: $TOOLCHAIN_FILE"
          CMAKE_ARGS=(
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN_FILE"
            -DCMAKE_BUILD_TYPE=Release
            -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON
            -DPORTABLE=ON
            -DWITH_SNAPPY=ON
            -DWITH_LZ4=ON
            -DWITH_ZLIB=ON
            -DWITH_ZSTD=ON
            -DROCKSDB_BUILD_SHARED=OFF
            -DWITH_GFLAGS=OFF
          )
          if [[ "${{ matrix.platform.runner }}" == *"windows"* ]]; then
            CMAKE_ARGS+=(
              -DVCPKG_TARGET_TRIPLET=${{ matrix.platform.target }}
              -DCMAKE_PREFIX_PATH="$INSTALLED_DIR"
            )
          fi
          cmake .. "${CMAKE_ARGS[@]}"
          echo "CMake configuration complete. Checking Snappy detection:"
          cmake -N -L .. | grep -i snappy || true
          cmake --build . --config Release
          ls -la
          cd ..

          echo "Copying files to dist..."
          mkdir -p dist/include
          mkdir -p dist/lib
          mv include/rocksdb dist/include/

          # linux/macos
          cp build/librocksdb.a dist/lib/

          # windows
          cp build/rocksdb.lib dist/lib/
          cp build/rocksdbd.lib dist/lib/

          echo "Creating archive..."
          ARCHIVE="${{ github.workspace }}/rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}.tar.xz"
          cd dist
          tar -cf - . | xz -9 > $ARCHIVE
          ls -la
          echo "archive=$ARCHIVE" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}
          path: ${{ steps.build.outputs.archive }}

  # release:
  #   name: Release
  #   needs: [check, build]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: artifacts

  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: us-east-2

  #     - name: Upload artifacts to S3
  #       run: |
  #         aws s3 cp artifacts/ s3://harper-artifacts/rocksdb-prebuilds/v${{ needs.check.outputs.version }}/ --recursive

  #     - name: Create release
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: artifacts/**/*.tar.xz
  #         body: |
  #           Automated prebuilds for RocksDB v${{ needs.check.outputs.version }}

  #           Release notes: https://github.com/facebook/rocksdb/releases/tag/v${{ needs.check.outputs.version }}
  #         name: RocksDB v${{ needs.check.outputs.version }}
  #         tag_name: v${{ needs.check.outputs.version }}
  #         token: ${{ secrets.GH_TOKEN }}

  #     - name: Send Slack notification
  #       uses: slackapi/slack-github-action@v2.0.0
  #       with:
  #         method: chat.postMessage
  #         token: ${{ secrets.SLACK_BOT_TOKEN }}
  #         payload: |
  #           {
  #             "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
  #             "text": "New RocksDB prebuild: v${{ needs.check.outputs.version }}",
  #             "blocks": [
  #               {
  #                 "type": "header",
  #                 "text": {
  #                   "type": "plain_text",
  #                   "text": "New RocksDB prebuild: v${{ needs.check.outputs.version }}"
  #                 }
  #               },
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "https://github.com/harperdb/rocksdb-prebuilds/releases/tag/v${{ needs.check.outputs.version }}"
  #                 }
  #               }
  #             ]
  #           }

  #     - name: Repository Dispatch
  #       uses: peter-evans/repository-dispatch@v3
  #       with:
  #         event-type: new-rocksdb-prebuild
  #         repository: harperdb/rocksdb-js
  #         token: ${{ secrets.GH_TOKEN }}
  #         client-payload: |
  #           {
  #             "url": "https://github.com/harperdb/rocksdb-prebuilds/releases/tag/v${{ needs.check.outputs.version }}",
  #             "version": "${{ needs.check.outputs.version }}"
  #           }
