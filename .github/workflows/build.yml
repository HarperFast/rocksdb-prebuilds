name: Automated RocksDB Builds

on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:

jobs:
  check:
    name: Check for new release
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check-build.outputs.should_build }}
      version: ${{ steps.latest-rocksdb.outputs.version }}
    steps:
      - name: Get latest RocksDB release
        id: latest-rocksdb
        shell: bash
        run: |
          URL="https://api.github.com/repos/facebook/rocksdb/releases/latest"
          LATEST=$(curl -s -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -X GET "$URL" | jq -r '.tag_name' | tr -d 'v')
          echo "Latest RocksDB release: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Get latest prebuild
        id: latest-prebuild
        shell: bash
        run: |
          URL="https://api.github.com/repos/harperdb/rocksdb-prebuilds/releases/latest"
          LATEST=$(curl -s -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -X GET "$URL" | jq -r '.tag_name' | tr -d 'v')
          echo "Latest RocksDB prebuild: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Check if we should build
        id: check-build
        shell: bash
        run: |
          if [[ "${{ steps.latest-rocksdb.outputs.version }}" != "${{ steps.latest-prebuild.outputs.version }}" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "New RocksDB release!"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No new RocksDB release"
          fi

  build:
    name: Build
    needs: [check]
    if: ${{ needs.check.outputs.should_build == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: macos-latest
            target: darwin-arm64
          # - runner: macos-latest
          #   target: darwin-x64
          # - runner: ubuntu-22.04
          #   target: linux-x64-glibc
          # - runner: ubuntu-latest
          #   target: linux-x64-musl
          # - runner: ubuntu-22.04-arm
          #   target: linux-arm64-glibc
          # - runner: ubuntu-24.04-arm
          #   target: linux-arm64-musl
          # - runner: windows-latest
          #   target: windows-x64
          # - runner: windows-latest
          #   target: windows-arm64
    runs-on: ${{ matrix.platform.runner }}
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cmake 3.31.10 (windows)
        if: ${{ matrix.platform.target == 'windows-x64' || matrix.platform.target == 'windows-arm64' }}
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.31.10

      - name: Build RocksDB (windows)
        if: ${{ matrix.platform.target == 'windows-x64' || matrix.platform.target == 'windows-arm64' }}
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        shell: bash
        run: |
          # Install vcpkg
          git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          "$VCPKG_ROOT/bootstrap-vcpkg.bat"
          VCPKG_CMD="$VCPKG_ROOT/vcpkg.exe"

          # Determine triplet based on target architecture
          if [ "${{ matrix.platform.target }}" == "windows-arm64" ]; then
            VCPKG_TRIPLET="arm64-windows"
            CMAKE_ARCH="ARM64"
          else
            VCPKG_TRIPLET="x64-windows"
            CMAKE_ARCH="x64"
          fi

          echo "VCPKG_ROOT: $VCPKG_ROOT"
          echo "VCPKG_TRIPLET: $VCPKG_TRIPLET"
          echo "CMAKE_ARCH: $CMAKE_ARCH"
          cmake --version

          # Install compression libraries
          "$VCPKG_CMD" install snappy lz4 zlib zstd --triplet "$VCPKG_TRIPLET" --host-triplet "$VCPKG_TRIPLET"

          # Download RocksDB
          URL="https://github.com/facebook/rocksdb/archive/refs/tags/v${{ needs.check.outputs.version }}.tar.gz"
          echo "Downloading: $URL"
          curl -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -o rocksdb.tar.gz "$URL"

          tar -xzf rocksdb.tar.gz
          cp windows/thirdparty.inc rocksdb-${{ needs.check.outputs.version }}/
          cd rocksdb-${{ needs.check.outputs.version }}
          mkdir build
          mkdir -p dist/include
          mkdir -p dist/lib

          # Export vcpkg variables to be used in thirdparty.inc
          export VCPKG_ROOT="$VCPKG_ROOT"
          export VCPKG_TRIPLET="$VCPKG_TRIPLET"

          # -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \

          cd build
          echo "Building RocksDB (release)..."
          cmake .. \
            -A "$CMAKE_ARCH" \
            -DCMAKE_PREFIX_PATH="$VCPKG_ROOT/installed/$VCPKG_TRIPLET" \
            -DVCPKG_TARGET_TRIPLET="$VCPKG_TRIPLET" \
            -DCMAKE_BUILD_TYPE=Release \
            -DPORTABLE=ON \
            -DWITH_SNAPPY=ON \
            -DWITH_LZ4=ON \
            -DWITH_ZLIB=ON \
            -DWITH_ZSTD=ON \
            -DROCKSDB_BUILD_SHARED=OFF \
            -DWITH_GFLAGS=OFF \
            -DWITH_TESTS=OFF \
            -DBUILD_TESTING=OFF
          cmake --build . --config Release --target rocksdb
          mv Release/rocksdb.lib ../dist/lib/

          # echo "Building RocksDB (debug)..."
          # cmake .. \
          #   -A "$CMAKE_ARCH" \
          #   -DCMAKE_PREFIX_PATH="$VCPKG_ROOT/installed/$VCPKG_TRIPLET" \
          #   -DVCPKG_TARGET_TRIPLET="$VCPKG_TRIPLET" \
          #   -DCMAKE_CXX_FLAGS="-wd4702" \
          #   -DCMAKE_BUILD_TYPE=Debug \
          #   -DPORTABLE=ON \
          #   -DWITH_SNAPPY=ON \
          #   -DWITH_LZ4=ON \
          #   -DWITH_ZLIB=ON \
          #   -DWITH_ZSTD=ON \
          #   -DROCKSDB_BUILD_SHARED=OFF \
          #   -DWITH_GFLAGS=OFF \
          #   -DWITH_TESTS=OFF \
          #   -DBUILD_TESTING=OFF
          # cmake --build . --config Debug --target rocksdb
          # mv Debug/rocksdb.lib ../dist/lib/rocksdbd.lib
          cd ..

          mv include/rocksdb dist/include/

          echo "Creating archive..."
          ARCHIVE="${{ github.workspace }}/rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}.tar.xz"
          cd dist
          tar -cf - . | xz -9 > "$ARCHIVE"
          echo "Archive created: $ARCHIVE"

      - name: Build RocksDB (macos)
        if: ${{ matrix.platform.target == 'darwin-arm64' || matrix.platform.target == 'darwin-x64' }}
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        shell: bash
        run: |
          # Install vcpkg
          git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          $VCPKG_ROOT/bootstrap-vcpkg.sh

          if [[ "${{ matrix.platform.target }}" == "darwin-arm64" ]]; then
            VCPKG_TRIPLET="arm64-osx"
          else
            VCPKG_TRIPLET="x64-osx"
          fi

          echo "VCPKG_ROOT: $VCPKG_ROOT"
          echo "VCPKG_TRIPLET: $VCPKG_TRIPLET"

          # Install compression libraries
          export VCPKG_LIBRARY_LINKAGE=static
          export CXXFLAGS="-fno-rtti"
          export VCPKG_CXX_FLAGS="-fno-rtti"
          $VCPKG_ROOT/vcpkg install snappy lz4 zlib zstd --triplet "$VCPKG_TRIPLET"
          # unset CXXFLAGS

          # Download RocksDB
          URL="https://github.com/facebook/rocksdb/archive/refs/tags/v${{ needs.check.outputs.version }}.tar.gz"
          echo "Downloading: $URL"
          curl -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -o rocksdb.tar.gz "$URL"

          tar -xzf rocksdb.tar.gz
          cd rocksdb-${{ needs.check.outputs.version }}
          patch -p1 < "${{ github.workspace }}/patches/0001-fix-dependencies.patch"
          patch -p1 < "${{ github.workspace }}/patches/0002-fix-android.patch"
          patch -p1 < "${{ github.workspace }}/patches/0003-include_cstdint.patch"
          patch -p1 < "${{ github.workspace }}/patches/0004-support-apple.patch"

          mkdir build
          cd build

          echo "Building RocksDB..."
          cmake .. \
            -DFAIL_ON_WARNINGS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_DISABLE_FIND_PACKAGE_Git=TRUE \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DPORTABLE=ON \
            -DROCKSDB_BUILD_SHARED=OFF \
            -DUSE_RTTI=ON \
            -DWITH_BENCHMARK_TOOLS=OFF \
            -DWITH_GFLAGS=OFF \
            -DWITH_LIBURING=OFF \
            -DWITH_LZ4=ON \
            -DWITH_SNAPPY=ON \
            -DWITH_TESTS=OFF \
            -DWITH_TOOLS=OFF \
            -DWITH_ZLIB=ON \
            -DWITH_ZSTD=ON \
            -DWITH_RUNTIME_DEBUG=OFF \
            -DVCPKG_TARGET_TRIPLET="$VCPKG_TRIPLET"
          cmake --build . --config Release --target rocksdb
          cd ..

          echo "Copying files to dist..."
          mkdir -p dist/include
          mkdir -p dist/lib
          mv include/rocksdb dist/include/
          mv build/librocksdb.a dist/lib/

          # Create a combined static library with all dependencies
          # echo "Creating combined static library with all dependencies..."
          # VCPKG_LIB_DIR="$VCPKG_ROOT/installed/$VCPKG_TRIPLET/lib"

          # # Use libtool on macOS to combine static libraries
          # libtool -static -o dist/lib/librocksdb.a \
          #   build/librocksdb.a \
          #   "$VCPKG_LIB_DIR/libsnappy.a" \
          #   "$VCPKG_LIB_DIR/liblz4.a" \
          #   "$VCPKG_LIB_DIR/libz.a" \
          #   "$VCPKG_LIB_DIR/libzstd.a"

          # # Verify the combined library
          # echo "Library size: $(du -h dist/lib/librocksdb.a | cut -f1)"
          # echo "Verifying snappy symbols are present..."
          # nm dist/lib/librocksdb.a | grep -c snappy || echo "Warning: snappy symbols not found"

          echo "Creating archive..."
          ARCHIVE="${{ github.workspace }}/rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}.tar.xz"
          cd dist
          tar -cf - . | xz -9 > "$ARCHIVE"
          echo "Archive created: $ARCHIVE"

      - name: Build RocksDB (linux glibc)
        if: ${{ matrix.platform.target == 'linux-x64-glibc' || matrix.platform.target == 'linux-arm64-glibc' }}
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        shell: bash
        run: |
          # Install vcpkg
          git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          $VCPKG_ROOT/bootstrap-vcpkg.sh

          echo "VCPKG_ROOT: $VCPKG_ROOT"

          # Install compression libraries
          export VCPKG_LIBRARY_LINKAGE=static
          $VCPKG_ROOT/vcpkg install snappy lz4 zlib zstd

          # Download RocksDB
          URL="https://github.com/facebook/rocksdb/archive/refs/tags/v${{ needs.check.outputs.version }}.tar.gz"
          echo "Downloading: $URL"
          curl -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -o rocksdb.tar.gz "$URL"

          tar -xzf rocksdb.tar.gz
          cd rocksdb-${{ needs.check.outputs.version }}
          mkdir build
          cd build

          echo "Building RocksDB..."
          cmake .. \
              -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
              -DCMAKE_BUILD_TYPE=Release \
              -DPORTABLE=ON \
              -DWITH_SNAPPY=ON \
              -DWITH_LZ4=ON \
              -DWITH_ZLIB=ON \
              -DWITH_ZSTD=ON \
              -DROCKSDB_BUILD_SHARED=OFF \
              -DWITH_GFLAGS=OFF \
              -DWITH_TESTS=OFF \
              -DWITH_BENCHMARK_TOOLS=OFF \
              -DWITH_TOOLS=OFF \
              -DUSE_RTTI=ON \
              -DFAIL_ON_WARNINGS=OFF \
              -DWITH_RUNTIME_DEBUG=OFF
          cmake --build . --config Release --target rocksdb
          cd ..

          echo "Copying files to dist..."
          mkdir -p dist/include
          mkdir -p dist/lib
          mv include/rocksdb dist/include/
          mv build/librocksdb.a dist/lib/

          echo "Creating archive..."
          ARCHIVE="${{ github.workspace }}/rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}.tar.xz"
          cd dist
          tar -cf - . | xz -9 > "$ARCHIVE"
          echo "Archive created: $ARCHIVE"

      - name: Build RocksDB (linux musl)
        if: ${{ matrix.platform.target == 'linux-x64-musl' || matrix.platform.target == 'linux-arm64-musl' }}
        shell: bash
        run: |
          # Download RocksDB
          URL="https://github.com/facebook/rocksdb/archive/refs/tags/v${{ needs.check.outputs.version }}.tar.gz"
          echo "Downloading: $URL"
          curl -L -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" -o rocksdb.tar.gz "$URL"

          # Build inside Alpine Docker container (musl)
          docker run --rm \
            -e VCPKG_ROOT="${{ env.VCPKG_ROOT }}" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            alpine:latest \
            sh -c "
              apk add --no-cache \
                build-base \
                cmake \
                curl \
                git \
                linux-headers \
                musl-dev \
                zlib-dev \
                snappy-dev \
                lz4-dev \
                zstd-dev \
                xz

              tar -xzf rocksdb.tar.gz
              cd rocksdb-${{ needs.check.outputs.version }}
              mkdir build
              cd build

              echo 'Building RocksDB...'
              cmake .. \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_CXX_FLAGS="-Wno-maybe-uninitialized" \
                -DPORTABLE=ON \
                -DWITH_SNAPPY=ON \
                -DWITH_LZ4=ON \
                -DWITH_ZLIB=ON \
                -DWITH_ZSTD=ON \
                -DROCKSDB_BUILD_SHARED=OFF \
                -DWITH_GFLAGS=OFF \
                -DWITH_TESTS=OFF \
                -DWITH_BENCHMARK_TOOLS=OFF \
                -DWITH_TOOLS=OFF \
                -DUSE_RTTI=ON \
                -DFAIL_ON_WARNINGS=OFF \
                -DWITH_RUNTIME_DEBUG=OFF
              cmake --build . --config Release --target rocksdb
              cd ..

              echo 'Copying files to dist...'
              mkdir -p dist/include
              mkdir -p dist/lib
              mv include/rocksdb dist/include/
              mv build/librocksdb.a dist/lib/

              echo 'Creating archive...'
              ARCHIVE=\"/workspace/rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}.tar.xz\"
              cd dist
              tar -cf - . | xz -9 > \$ARCHIVE
              echo \"Archive created: \$ARCHIVE\"
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}
          path: rocksdb-${{ needs.check.outputs.version }}-${{ matrix.platform.target }}.tar.xz

  # release:
  #   name: Release
  #   needs: [check, build]
  #   if: ${{ needs.check.outputs.should_build == 'true' }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: artifacts

  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: us-east-2

  #     - name: Upload artifacts to S3
  #       run: |
  #         aws s3 cp artifacts/ s3://harper-artifacts/rocksdb-prebuilds/v${{ needs.check.outputs.version }}/ --recursive

  #     - name: Create release
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: artifacts/**/*.tar.xz
  #         body: |
  #           Automated prebuilds for RocksDB v${{ needs.check.outputs.version }}

  #           Release notes: https://github.com/facebook/rocksdb/releases/tag/v${{ needs.check.outputs.version }}
  #         name: RocksDB v${{ needs.check.outputs.version }}
  #         tag_name: v${{ needs.check.outputs.version }}
  #         token: ${{ secrets.GH_TOKEN }}

  #     - name: Send Slack notification
  #       uses: slackapi/slack-github-action@v2.0.0
  #       with:
  #         method: chat.postMessage
  #         token: ${{ secrets.SLACK_BOT_TOKEN }}
  #         payload: |
  #           {
  #             "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
  #             "text": "New RocksDB prebuild: v${{ needs.check.outputs.version }}",
  #             "blocks": [
  #               {
  #                 "type": "header",
  #                 "text": {
  #                   "type": "plain_text",
  #                   "text": "New RocksDB prebuild: v${{ needs.check.outputs.version }}"
  #                 }
  #               },
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "https://github.com/harperdb/rocksdb-prebuilds/releases/tag/v${{ needs.check.outputs.version }}"
  #                 }
  #               }
  #             ]
  #           }

  #     - name: Repository Dispatch
  #       uses: peter-evans/repository-dispatch@v3
  #       with:
  #         event-type: new-rocksdb-prebuild
  #         repository: harperdb/rocksdb-js
  #         token: ${{ secrets.GH_TOKEN }}
  #         client-payload: |
  #           {
  #             "url": "https://github.com/harperdb/rocksdb-prebuilds/releases/tag/v${{ needs.check.outputs.version }}",
  #             "version": "${{ needs.check.outputs.version }}"
  #           }
